# DbQuery

Reads and enumerates the values from the specified data reader.

## Implementation by builder

Describes how to define fields using DataGeneratorBuilder.

### Sample code

```c#
// Gets the data reader.
using IDataReader sampleDataReader1 = GetSampleTable();
using IDataReader sampleDataReader2 = GetSampleTable();

// Create a context that controls the behavior of the generator.
// You can replace random number generation algorithms, string converters, etc. with your own implementation.
DataGeneratorContext context = new DataGeneratorContext();

// Creates a builder.
DataGeneratorBuilder builder = new DataGeneratorBuilder();

// Adds fields.
builder

  // One field.
  .AddField(factory => factory.FromDataReader(

    // Specifies the field name.
    "FIELD1",

    // Specifies the data reader.
    sampleDataReader1
    )
  )

  // Multiple fields.
  .AddTupleField(factory => factory.FromDataReader(

    // Specifies the field names.
    new[]
    {
      "FIELD2", "FIELD3", "FIELD4"
    },

    // Specifies the data reader.
    sampleDataReader2
    )
  )
;

// Creates a generator that generates 10 records and returns it as a DataReader.
using IDataReader reader = await builder.BuildAsDataReaderAsync(10);
```

The IDataReader generated by this sample code will generate the following data:

```console
FIELD1  FIELD2  FIELD3  FIELD4
------  ------  ------  ------
1       10      100     1.1
2       20      (null)  2.2
1       10      100     1.1
2       20      (null)  2.2
1       10      100     1.1
2       20      (null)  2.2
1       10      100     1.1
2       20      (null)  2.2
1       10      100     1.1
2       20      (null)  2.2
```

## Implementation by configuration

Describes how to use a configuration class to define the same fields as the sample code above.

### Sample code

```c#
// Creates a generator settings.
DataGeneratorSettings generatorSettings = new DataGeneratorSettings()
{
  Fields = new DataGeneratorFieldSettings[]
  {
    // One field.
    new DbQueryFieldSettings()
    {
    // Specifies the field name.
      FieldName = "FIELD1",

      // Specifies the query data source.
      DbQuerySettings = new DbQuerySettings()
      {
        CommandText = "select * from SAMPLE_TABLE",
        ConnectionString = "Provider=SQLOLEDB; Data Source=(local); Integrated Security=SSPI"
      }
    }
  },
  TupleFields = new DataGeneratorTupleFieldSettings[]
  {
    // Multiple fields.
    new DbQueryFieldsSettings()
    {
    // Specifies the field names.
      FieldNames = new[]
      {
        "FIELD2",
        "FIELD3",
        "FIELD4",
      },

      // Specifies the query data source.
      DbQuerySettings = new DbQuerySettings()
      {
        CommandText = "select * from SAMPLE_TABLE",
        ConnectionString = "Provider=SQLOLEDB; Data Source=(local); Integrated Security=SSPI"
      }
    }
  }
};

// Create a context that controls the behavior of the generator.
// You can replace random number generation algorithms, string converters, etc. with your own implementation.
DataGeneratorContext context = new DataGeneratorContext();

// Creates a builder.
DataGeneratorBuilder builder = generatorSetting.CreateBuilder(context);

// Creates a generator that generates 10 records and returns it as a DataReader.
using IDataReader reader = await builder.BuildAsDataReaderAsync(10);
```


### Json serialization

The DataGeneratorSettings instance in the sample code above is serialized into a JSON string like this:

```json
{
  "Fields": [
    {
      "Name": "FIELD1",
      "DbQuery": {
        "CommandText": "select * from SAMPLE_TABLE",
        "ConnectionString": "Provider=SQLOLEDB; Data Source=(local); Integrated Security=SSPI",
        "ConnectionType": null
      },
      "FieldType": "DbQueryField"
    }
  ],
  "TupleFields": [
    {
      "FieldNames": [
        "FIELD2",
        "FIELD3",
        "FIELD4"
      ],
      "DbQuery": {
        "CommandText": "select * from SAMPLE_TABLE",
        "ConnectionString": "Provider=SQLOLEDB; Data Source=(local); Integrated Security=SSPI",
        "ConnectionType": null
      },
      "FieldType": "DbQueryFields"
    }
  ],
  "AdditionalFields": null,
  "AdditionalTupleFields": null
}
```

### DbConnection used to execute a query

The connection used when executing a query using DbQuerySettings is created by the IDbProvider object stored in the DataGeneratorContext instance. 

The default IDbProvider object stored in the DataGeneratorContext instance creates a System.Data.OleDbConnection instance. To switch to your own implementation, pass an IDbProvider object to the constructor of the DataGeneratorContext.

```c#
IDbProvider provider = new CustomDbProvider();
DataGeneratorContext context = new DataGeneratorContext(dbProvider: provider);

internal class CustomDbProvider : IDbProvider
{
  internal CustomDbProvider() {}

  public IDbConnection CreateConnection(string connectionString, string? connectionTypeName = null)
  {
    // Returns a connection.
    // The values set in the DbQuerySettings property is passed to two parameters of this method, connectionString and connectionTypeName.
  }
}
```