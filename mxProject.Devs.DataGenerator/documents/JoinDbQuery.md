# JoinDbQuery

Takes the generated data record as an argument and returns the value corresponding to the value of the key field from the data reader.

## Implementation by builder

Describes how to define fields using DataGeneratorBuilder.

### Sample code

```c#
// Gets a data reader that returns the value to add.
using IDataReader shopDataReader = GetShopMaster();

// Create a context that controls the behavior of the generator.
// You can replace random number generation algorithms, string converters, etc. with your own implementation.
DataGeneratorContext context = new DataGeneratorContext();

// Creates a builder.
DataGeneratorBuilder builder = new DataGeneratorBuilder();

// Adds fields.
builder

  // This field returns the direct product of CompanyCode and ShopCode.
  .AddTupleField(factory => DirectProductFieldFactory.CreateTupleField(
    new IDataGeneratorField[]
    {
      factory.Each<int>("CompanyCode", new int?[]{ 1, 2, 3, null }),
      factory.Each<long>("ShopCode", new long?[]{ 1, 2, 3, null })
    },
    context
    )
  )

  // Add fields that return the value corresponding to (CompanyCode, ShopCode).
  .AddJoinField(factory => factory.WithDataReader(

    // Specifies the reference key field names.
    new string[] { "CompanyCode", "ShopCode" },

    // Specifies the additional key field names.
    new string[] { "COMPANY_CODE", "SHOP_CODE" },

    // Specifies the additional value field names.
    new string[] { "SHOP_NAME", "TELEPHONE_NUMBER" },

    // Specifies the data reader.
    shopDataReader
    )
  )
;

// Creates a generator that generates 10 records and returns it as a DataReader.
using IDataReader reader = await builder.BuildAsDataReaderAsync(10);
```

The IDataReader generated by this sample code will generate the following data:

```console
CompanyCode ShopCode SHOP_NAME TELEPHONE_NUMBER
----------- -------- --------- ----------------
1           1        shop1-1   000-0001-0001
1           2        shop1-2   000-0001-0002
1           3        shop1-3   000-0001-0003
1           (null)   (null)    (null)
2           1        shop2-1   000-0002-0001
2           2        (null)    (null)
2           3        (null)    (null)
2           (null)   (null)    (null)
3           1        (null)    (null)
3           2        (null)    (null)
```

## Implementation by configuration

Describes how to use a configuration class to define the same fields as the sample code above.

### Sample code

```c#
// Creates a generator settings.
DataGeneratorSettings generatorSetting = new DataGeneratorSettings()
{
  TupleFields = new DataGeneratorTupleFieldSettings[]
  {
    // This field returns the direct product of CompanyCode and ShopCode.
    new DirectProductFieldSettings()
    {
      Fields = new DataGeneratorFieldSettings[]
      {
        new EachFieldSettings<int>()
        {
          FieldName = "CompanyCode",
          Values = new int?[]{ 1, 2, 3, null }
        },
        new EachFieldSettings<long>()
        {
          FieldName = "ShopCode",
          Values = new long?[]{ 1, 2, 3, null }
        }
      }
    }
  },

  AdditionalTupleFields = new DataGeneratorAdditionalTupleFieldSettings[]
  {
    // Adds fields that return the value corresponding to (CompanyCode, ShopCode).
    new JoinDbQueryFieldSettings()
    {
      // Specifies the query data source.
      DbQuerySettings = new DbQuerySettings()
      {
        CommandText = "select * from SHOP_MASTER",
        ConnectionString = "Provider=SQLOLEDB; Data Source=(local); Integrated Security=SSPI"
      },

      // Specifies the reference key field names.
      ReferenceKeyFieldNames = new[]{ "CompanyCode", "ShopCode" },

      // Specifies the additional key field names.
      AdditionalKeyFieldNames = new[]{ "COMPANY_CODE", "SHOP_CODE" },

      // Specifies the additional value field names.
      AdditionalValueFieldNames = new[]{ "SHOP_NAME", "TELEPHONE_NUMBER" },
    }
  }
};

// Create a context that controls the behavior of the generator.
// You can replace random number generation algorithms, string converters, etc. with your own implementation.
DataGeneratorContext context = new DataGeneratorContext();

// Creates a builder.
DataGeneratorBuilder builder = generatorSetting.CreateBuilder(context);

// Creates a generator that generates 10 records and returns it as a DataReader.
using IDataReader reader = await builder.BuildAsDataReaderAsync(10);
```


### Json serialization

The DataGeneratorSettings instance in the sample code above is serialized into a JSON string like this:

```json
{
  "Fields": null,
  "TupleFields": [
    {
      "Fields": [
        {
          "Name": "CompanyCode",
          "NullProb": 0.0,
          "Values": [
            1,
            2,
            3,
            null
          ],
          "FieldType": "EachInt32"
        },
        {
          "Name": "ShopCode",
          "NullProb": 0.0,
          "Values": [
            1,
            2,
            3,
            null
          ],
          "FieldType": "EachInt64"
        }
      ],
      "FieldType": "DirectProduct"
    }
  ],
  "AdditionalFields": null,
  "AdditionalTupleFields": [
    {
      "AdditionalFields": [],
      "ReferenceKeys": [
        "CompanyCode",
        "ShopCode"
      ],
      "AdditionalKeys": [
        "COMPANY_CODE",
        "SHOP_CODE"
      ],
      "AdditionalValues": [
        "SHOP_NAME",
        "TELEPHONE_NUMBER"
      ],
      "DbQuery": {
        "CommandText": "select * from SHOP_MASTER",
        "ConnectionString": "Provider=SQLOLEDB; Data Source=(local); Integrated Security=SSPI",
        "ConnectionType": null
      },
      "FieldType": "JoinDbQuery"
    }
  ]
}
```

### DbConnection used to execute a query

The connection used when executing a query using DbQuerySettings is created by the IDbProvider object stored in the DataGeneratorContext instance. 

The default IDbProvider object stored in the DataGeneratorContext instance creates a System.Data.OleDbConnection instance. To switch to your own implementation, pass an IDbProvider object to the constructor of the DataGeneratorContext.

```c#
IDbProvider provider = new CustomDbProvider();
DataGeneratorContext context = new DataGeneratorContext(dbProvider: provider);

internal class CustomDbProvider : IDbProvider
{
  internal CustomDbProvider() {}

  public IDbConnection CreateConnection(string connectionString, string? connectionTypeName = null)
  {
    // Returns a connection.
    // The values set in the DbQuerySettings property is passed to two parameters of this method, connectionString and connectionTypeName.
  }
}
```